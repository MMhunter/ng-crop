"use strict";angular.module("ngCrop",[]).directive("ngCrop",function(){return{restrict:"E",scope:{img:"@",resultData:"=",width:"@",height:"@",maxWidth:"@",maxHeight:"@"},replace:true,template:'<div class="ng-crop" style="width:{{width}}px;height:{{height}}px"><canvas width="{{width}}px" height="{{height}}px" ng-class="{\'dragging\':canvasClass}"></canvas></div>',link:function(m,d,k){m.canvas=d[0].getElementsByTagName("canvas")[0];m.context=m.canvas.getContext("2d");var n=(function(){return{x:0,y:0,h:0,w:0,clear:function(){this.x=0;this.y=0;this.h=0;this.w=0}}})();var b=new Image();var a="notMoving";var l=0;var j=0;var h=0;m.canvas.addEventListener("mousedown",s);m.canvas.addEventListener("mousemove",c);m.canvas.addEventListener("mouseup",q);m.canvas.addEventListener("mouseout",q);document.addEventListener("keydown",p);document.addEventListener("keyup",g);m.$on("$destroy",function(){document.removeEventListener("keydown",p);document.removeEventListener("keyup",g)});m.$watch("img",function(){if(typeof m.img!="undefined"){b.onload=function(){if(typeof m.width==="undefined"||typeof m.height==="undefined"){m.width=b.width;m.height=b.height;h=1}else{var v=b.height/b.width;if(v>m.height/m.width){var u=m.canvas.height/v;m.canvas.width=u;var w=m.canvas.height;h=b.height/m.canvas.height}else{var w=m.canvas.width*v;var u=m.canvas.width;m.canvas.height=w;h=b.width/m.canvas.width}}f();e()};if(typeof m.img=="bolb"){var t=new FileReader();t.readAsDataURL(m.img);t.onload=function(u){b.src=u.target.result}}else{b.src=m.img}}else{m.canvas.width=m.width;m.canvas.height=m.height}});function f(){n.clear();if(!m.square){if(h!==1){n.w=m.canvas.width*0.8;n.h=m.canvas.height*0.8}else{n.w=b.width*0.8;n.h=b.height*0.8}}else{if(m.canvas.height>50&&m.canvas.width>50){n.w=50;n.h=50}else{if(m.canvas.height<50){n.w=m.canvas.height;n.h=m.canvas.height}else{n.w=m.canvas.width;n.h=m.canvas.width}}}i()}function i(){m.context.clearRect(0,0,m.canvas.width,m.canvas.height);m.context.globalAlpha=0.3;m.context.drawImage(b,0,0,b.width,b.height,0,0,m.canvas.width,m.canvas.height);m.context.save();m.context.beginPath();m.context.rect(n.x,n.y,n.w,n.h);m.context.closePath();m.context.clip();m.context.globalAlpha=1;m.context.drawImage(b,0,0,b.width,b.height,0,0,m.canvas.width,m.canvas.height);m.context.restore();m.context.globalAlpha=1;m.context.fillStyle="rgb(255,255,255)";m.context.fillRect(n.x-5,n.y-5,10,10);m.context.strokeRect(n.x-5,n.y-5,10,10);m.context.fillRect(n.x-5+n.w,n.y-5,10,10);m.context.strokeRect(n.x-5+n.w,n.y-5,10,10);m.context.fillRect(n.x-5+n.w,n.y-5+n.h,10,10);m.context.strokeRect(n.x-5+n.w,n.y-5+n.h,10,10);m.context.fillRect(n.x-5,n.y-5+n.h,10,10);m.context.strokeRect(n.x-5,n.y-5+n.h,10,10)}function s(w){var u=o(m.canvas,w);var t={x:n.x,y:n.y};var v={x:n.x+n.w,y:n.y};var x={x:n.x,y:n.y+n.h};var y={x:n.x+n.w,y:n.y+n.h};if(r(u,t)){a="leftTop"}else{if(r(u,v)){a="rightTop"}else{if(r(u,x)){a="leftBottom"}else{if(r(u,y)){a="rightBottom"}else{if(u.x>t.x&&u.y>t.y&&u.x<y.x&&u.y<y.y){a="moving";l=u.x-t.x;j=u.y-t.y}else{a="notMoving"}}}}}}function c(w){var u=o(m.canvas,w);var t={x:n.x,y:n.y};var v={x:n.x+n.w,y:n.y};var x={x:n.x,y:n.y+n.h};var y={x:n.x+n.w,y:n.y+n.h};if(a=="moving"){if(u.x-l>=0&&u.x-l+n.w<=m.canvas.width&&u.y-j>=0&&u.y-j+n.h<=m.canvas.height){n.x=u.x-l;n.y=u.y-j;m.canvasClass="dragging"}else{if(u.x-l<0){n.x=0}else{if(u.x-l+n.w>m.canvas.width){n.x=m.canvas.width-n.w}else{n.x=u.x-l}}if(u.y-j<0){n.y=0}else{if(u.y-j+n.h>m.canvas.height){n.y=m.canvas.height-n.h}else{n.y=u.y-j}}}}else{if(a=="leftTop"){if(!m.square){n.x=(u.x>v.x-50)?v.x-50:u.x;n.w=(u.x>v.x-50)?50:v.x-u.x;n.y=(u.y>y.y-50)?y.y-50:u.y;n.h=(u.y>y.y-50)?50:y.y-u.y}else{if(n.y>=0){n.x=(u.x>v.x-50)?v.x-50:u.x;n.w=(u.x>v.x-50)?50:v.x-u.x;n.y=y.y-n.w;n.h=n.w}}}else{if(a=="rightTop"){if(!m.square){n.w=(u.x<t.x+50)?50:u.x-t.x;n.y=(u.y>y.y-50)?y.y-50:u.y;n.h=(u.y>y.y-50)?50:y.y-u.y}else{if(n.y>=0){n.w=(u.x<t.x+50)?50:u.x-t.x;n.y=y.y-n.w;n.h=n.w}}}else{if(a=="leftBottom"){if(!m.square){n.x=(u.x>v.x-50)?v.x-50:u.x;n.w=(u.x>v.x-50)?50:v.x-u.x;n.h=(u.y<v.y+50)?50:u.y-v.y}else{if(n.x>=0){n.x=v.x-n.h;n.w=n.h;n.h=(u.y<v.y+50)?50:u.y-v.y}}}else{if(a=="rightBottom"){if(!m.square){n.w=(u.x<t.x+50)?50:u.x-t.x;n.h=(u.y<t.y+50)?50:u.y-t.y}else{if(n.y>=0){n.w=(u.x<t.x+50)?50:u.x-t.x;n.h=n.w}}}}}}}i()}function q(){a="notMoving";m.canvasClass="";e()}function e(){var u=document.createElement("canvas");console.log("Crop");var z=n.h*h;var t=n.w*h;var y=t/z;u.height=z;u.width=t;var x,w;if(typeof m.maxWidth==="undefined"){w=b.width}else{w=m.maxWidth}if(typeof m.maxHeight==="undefined"){x=b.height}else{x=m.maxHeight}if(y>w/x&&t>w){u.width=w;u.height=w/y}else{if(y<=w/x&&z>x){u.width=x*y;u.height=x}else{u.height=z;u.width=t}}var v=u.getContext("2d");v.drawImage(b,n.x*h,n.y*h,Math.min(n.w*h,b.width),Math.min(n.h*h,b.height),0,0,u.width,u.height);m.$apply(function(){m.resultData=u.toDataURL()})}function o(u,t){var v=u.getBoundingClientRect();return{x:t.clientX-v.left,y:t.clientY-v.top}}function r(v,u){var t=5;return Math.abs(v.x-u.x)<t&&Math.abs(v.y-u.y)<t}function p(t){if(t.keyCode==16){m.square=true}}function g(t){if(t.keyCode==16){m.square=false}}}}});